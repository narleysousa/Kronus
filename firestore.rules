rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Kronus: documento único com users, logs, justificativas, férias e avisos.
    // Estrutura esperada: { users, logs, pendingJustifications, vacations, relaxNotice }
    match /kronus/appData {

      // Valida estrutura do documento na escrita (evita dados corrompidos)
      function isValidKronusData() {
        let data = request.resource.data;
        return data.keys().hasAll(['users', 'logs', 'pendingJustifications', 'vacations', 'relaxNotice'])
            && data.users is list
            && data.logs is list
            && data.pendingJustifications is map
            && data.vacations is map
            && data.relaxNotice is map
            && data.users.size() <= 500
            && data.logs.size() <= 100000;
      }

      // Leitura: somente usuários autenticados com e-mail verificado (Email/Password)
      allow read: if request.auth != null && request.auth.token.email_verified == true;

      // Escrita: só se o payload tiver a estrutura válida do Kronus e e-mail verificado
      allow write: if request.auth != null && request.auth.token.email_verified == true && isValidKronusData();
    }

    // Bloqueia qualquer outro path no Firestore (segurança)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
